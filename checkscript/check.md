# 🛡️ 系统综合巡检工具 (check.sh) 详细介绍

## 📋 概述

`check.sh` 是一个功能全面的Linux系统巡检工具，专为系统管理员设计，用于定期检查服务器的健康状态、安全配置和性能指标。该脚本整合了安全检测、性能监控、环境变量检查、句柄分析、服务状态监控等多项功能。

## ✨ 主要特性

- 🔍 **全面性**: 涵盖系统信息、安全、性能、服务状态等多个维度
- 🤖 **自动化**: 一键执行，生成详细巡检报告
- 🎨 **可视化**: 彩色输出，清晰区分正常、警告和错误状态
- 🧠 **智能化**: 自动检测和安装必要依赖工具
- 📊 **标准化**: 生成时间戳命名的巡检报告文件

## 🔧 系统要求

### 🚨 运行权限
- **必须以root权限运行**，脚本会自动检查权限并提示

### 📦 依赖工具
脚本会自动检查并安装以下工具（如果缺失）：
- 📊 `sysstat` - 系统性能监控工具集
- 💾 `iotop` - I/O监控工具
- 🌐 `net-tools` - 网络工具集

### 支持的Linux发行版
- Ubuntu/Debian系列（使用apt包管理器）
- CentOS/RHEL系列（使用yum包管理器）

### ✅ 已验证的操作系统版本
🎯 **CentOS 7** - 完全兼容，修复了颜色显示和格式问题  
🎯 **Ubuntu 24.04** - 完全兼容，所有功能正常运行  
🎯 **Debian 13** - 完全兼容，系统检测准确  

### 🔄 系统兼容性说明
- 🖥️ **CentOS 7**: 已针对颜色输出、文件权限检测、子shell输出等问题进行专门优化
- 🐧 **Ubuntu 24.04**: 支持最新系统架构和工具链
- 🔴 **Debian 13**: 兼容传统和现代化系统配置
- ⚡ 其他版本理论上兼容，建议在实际环境中测试验证

## 功能模块详解

### 1. 系统基本信息
- **操作系统版本**: 从 `/etc/os-release` 获取系统信息
- **内核版本**: 显示当前运行的内核版本
- **主机名**: 系统主机名
- **IP地址**: 主要网络接口IP地址
- **运行时间**: 系统启动后的运行时长

### 2. 环境变量安全检测

#### 2.1 PATH环境变量分析
- **路径统计**: 统计PATH中包含的路径数量
- **危险路径检测**: 识别以下危险路径
  - `/` (根目录)
  - `/root` (root用户目录)
  - `/tmp` (临时目录)
  - `/var/tmp` (临时目录)
  - `/dev/shm` (共享内存)
- **可写路径风险**: 检查PATH中是否包含非标准权限的可写目录

#### 2.2 敏感环境变量扫描
检测包含以下关键词的环境变量：
- PASSWORD, SECRET, KEY, TOKEN
- CREDENTIAL, PASS, DB_PASS

#### 2.3 环境配置文件权限检查
检查重要配置文件的权限设置：
- `/etc/profile`
- `/etc/bashrc`
- `~/.bashrc`
- `~/.bash_profile`

### 3. 系统句柄数分析

#### 3.1 句柄限制配置
- **系统级限制**: 从 `/proc/sys/fs/file-max` 获取系统最大句柄数
- **当前使用量**: 从 `/proc/sys/fs/file-nr` 获取已使用句柄数
- **用户级限制**: 显示软限制和硬限制 (`ulimit -Sn`, `ulimit -Hn`)
- **使用率计算**: 计算系统句柄整体使用率
- **风险预警**: 当使用率超过80%时发出警告

#### 3.2 进程句柄TOP分析
- 使用 `lsof` 命令分析各进程的句柄使用情况
- 显示句柄使用量最高的TOP 10进程
- 包含进程ID、句柄数量、进程名称

### 4. 系统性能深度检测

#### 4.1 CPU性能分析
- **硬件信息**: CPU型号和核心数
- **实时使用率**: 使用 `mpstat` 工具进行5秒采样
- **进程分析**: 显示CPU占用TOP 5进程
- **性能预警**: CPU使用率超过80%时发出警告

#### 4.2 内存性能分析
- **内存统计**: 总内存、已使用、空闲、可用内存
- **使用率计算**: 计算内存使用百分比
- **进程分析**: 显示内存占用TOP 5进程
- **性能预警**: 内存使用率超过85%时发出警告

#### 4.3 磁盘性能分析
- **分区使用率**: 使用 `df -h` 显示各分区使用情况
- **容量预警**: 分区使用率超过85%时发出警告
- **I/O性能**: 使用 `iostat` 监控磁盘读写速度和利用率

#### 4.4 网络性能分析
- **接口流量**: 使用 `sar -n DEV` 监控网络接口流量
- **连接状态**: 统计TCP连接的各种状态分布

### 5. 系统安全检测

#### 5.1 用户安全检查
- **空密码账户**: 检查 `/etc/shadow` 中的空密码账户
- **特权用户**: 识别UID为0的非root用户账户

#### 5.2 关键文件权限检查
检查以下重要系统文件的权限设置：
- `/etc/passwd` - 用户账户信息
- `/etc/shadow` - 用户密码信息（应为400权限）
- `/etc/sudoers` - sudo配置文件（应为440权限）
- `/etc/group` - 用户组信息
- `/etc/hosts` - 主机名解析
- `/etc/resolv.conf` - DNS配置

#### 5.3 SSH与防火墙检查
- **SSH配置**: 检查是否禁用root直接登录
- **防火墙状态**: 检查UFW或firewalld的运行状态

### 6. 服务状态与系统更新

#### 6.1 关键服务状态检查
监控以下重要服务的运行状态：
- `sshd` - SSH服务
- `firewalld` - 防火墙服务
- `crond` - 定时任务服务
- `rsyslog` - 日志服务
- `docker` - Docker服务
- `nginx` - Nginx Web服务器
- `mysql` - MySQL数据库
- `redis` - Redis缓存服务

#### 6.2 系统更新检查
- **APT系统**: 检查可用更新和安全更新数量
- **YUM系统**: 检查可用更新和安全更新数量

### 7. 日志与定时任务检查

#### 7.1 错误日志检查
- 扫描 `/var/log/messages` 和 `/var/log/syslog`
- 查找包含错误、失败、严重等关键词的日志条目
- 显示最近10条相关日志

#### 7.2 登录失败检查
- 检查 `/var/log/secure` 和 `/var/log/auth.log`
- 查找登录失败记录
- 显示最近5条失败登录尝试

#### 7.3 定时任务安全检查
- 扫描 `/etc/cron*` 目录中的定时任务
- 识别可能包含风险的命令（wget, curl, bash -i, nc等）

## 📊 输出与报告

### 🌈 彩色输出说明
- 🔴 **红色**: 错误、危险、需要立即关注的问题
- 🟡 **黄色**: 警告、建议关注的事项
- 🔵 **蓝色**: 模块标题和分类信息
- 🟢 **绿色**: 正常状态、安全配置

### 📄 报告文件
- 📅 **文件名格式**: `system_inspection_YYYYMMDD_HHMMSS.log`
- 📝 **内容**: 包含所有检查结果的详细记录
- 📍 **位置**: 脚本执行目录

## 🚀 使用方法

### 🎯 基本用法
```bash
# 确保脚本有执行权限
chmod +x check.sh

# 以root权限执行
sudo ./check.sh
```

### ⏰ 定期执行建议
建议将此脚本加入定时任务，定期执行：

```bash
# 编辑crontab
crontab -e

# 📅 添加定时任务（每天凌晨2点执行）
0 2 * * * /path/to/check.sh

# 📅 或每周执行一次（每周一凌晨2点）
0 2 * * 1 /path/to/check.sh
```

## ❓ 常见问题解决

### 🚫 1. 权限不足错误
```
❌ 错误：此脚本需要以root权限运行，请使用sudo或切换到root用户
```
**✅ 解决方案**: 使用 `sudo ./check.sh` 执行脚本

### 📦 2. 依赖工具缺失
脚本会自动尝试安装缺失的工具，如果自动安装失败：

**🐧 Ubuntu/Debian系统**:
```bash
sudo apt update
sudo apt install sysstat iotop net-tools
```

**🖥️ CentOS/RHEL系统**:
```bash
sudo yum install sysstat iotop net-tools
```

### 🔧 3. 某些命令不存在
如果遇到 `command not found` 错误，可能需要安装额外的工具包：
```bash
# 🛠️ 安装额外工具
sudo apt install bc lsof psmisc  # 🐧 Ubuntu/Debian
sudo yum install bc lsof psmisc  # 🖥️ CentOS/RHEL
```

## 🔒 安全注意事项

1. 🛡️ **权限管理**: 脚本需要root权限，请确保在安全的环境中运行
2. 🔍 **敏感信息**: 脚本会扫描环境变量中的敏感信息，但不会记录具体内容
3. 📝 **日志安全**: 生成的报告文件包含系统敏感信息，请妥善保管
4. 🔄 **定期更新**: 建议定期更新脚本以适应新的安全威胁和检查需求

## 🚀 未来计划

### 🔧 自定义检查项
可以根据实际需求在脚本中添加：
- 📱 特定应用程序的健康检查
- ⚙️ 自定义配置文件的权限检查
- 🔌 特定端口的监听状态检查
- 🗄️ 数据库连接测试

### 📈 报告优化
- 📋 添加JSON格式输出支持
- 📧 集成邮件通知功能
- 📊 添加图表生成功能
- 🌐 支持远程报告推送

## 🎉 总结

这个系统巡检脚本是一个功能强大的系统维护工具，能够全面检查Linux服务器的各个方面。通过定期运行此脚本，系统管理员可以：

- ⚡ 及时发现系统性能瓶颈
- 🚨 识别潜在的安全风险
- 📊 监控关键服务状态
- 🔐 确保系统配置的安全性
- 📈 建立系统健康状态的历史记录

💡 **建议**: 将此脚本纳入日常运维流程，结合其他监控工具，构建完整的系统监控体系。

---
*🛡️ 由 Feiecho 精心维护，持续更新优化中...*
<div align="center">
  <b>⭐ 如果这个项目对你有帮助，请给它一个星标！</b>
</div>